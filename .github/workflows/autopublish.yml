name: Auto-publish post

on:
  schedule:
    # Phase 1: Generate draft at 05:00 Moscow (02:00 UTC)
    - cron: '0 2 * * *'
    # Phase 2: Auto-publish at 15:00 Moscow (12:00 UTC)
    - cron: '0 12 * * *'
  workflow_dispatch:
    inputs:
      phase:
        description: 'Phase to run'
        required: true
        default: 'generate'
        type: choice
        options:
          - generate
          - publish
          - full
      text_provider:
        description: 'Text provider'
        required: false
        default: 'openai'
        type: choice
        options:
          - openai
          - claude
          - gemini
      image_provider:
        description: 'Image provider'
        required: false
        default: 'openai'
        type: choice
        options:
          - openai
          - gemini

permissions:
  contents: write

# ── Phase 1: Generate draft ─────────────────────────────────────────────────

jobs:
  generate:
    runs-on: ubuntu-latest
    if: >-
      (github.event_name == 'schedule' && github.event.schedule == '0 2 * * *')
      || (github.event_name == 'workflow_dispatch' && github.event.inputs.phase == 'generate')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if autopublish is enabled
        id: check
        run: |
          if [ -f provider.cfg ]; then
            ENABLED=$(grep AUTOPUBLISH_ENABLED provider.cfg | cut -d= -f2 || echo "true")
          else
            ENABLED="true"
          fi
          echo "enabled=$ENABLED" >> $GITHUB_OUTPUT
          echo "Autopublish enabled: $ENABLED"

      - name: Set up Python
        if: steps.check.outputs.enabled != 'false'
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        if: steps.check.outputs.enabled != 'false'
        run: pip install anthropic google-genai openai replicate requests python-dotenv Pillow pypdf python-docx

      - name: Read provider config
        if: steps.check.outputs.enabled != 'false'
        id: providers
        run: |
          if [ -f provider.cfg ]; then
            echo "text=$(grep TEXT_PROVIDER provider.cfg | cut -d= -f2)" >> $GITHUB_OUTPUT
            echo "image=$(grep IMAGE_PROVIDER provider.cfg | cut -d= -f2)" >> $GITHUB_OUTPUT
            echo "face_swap=$(grep FACE_SWAP_PROVIDER provider.cfg | cut -d= -f2)" >> $GITHUB_OUTPUT
            echo "image_source=$(grep IMAGE_SOURCE provider.cfg | cut -d= -f2)" >> $GITHUB_OUTPUT
          else
            echo "text=openai" >> $GITHUB_OUTPUT
            echo "image=openai" >> $GITHUB_OUTPUT
            echo "face_swap=" >> $GITHUB_OUTPUT
            echo "image_source=generate" >> $GITHUB_OUTPUT
          fi

      - name: Generate draft
        if: steps.check.outputs.enabled != 'false'
        env:
          TEXT_PROVIDER: ${{ github.event.inputs.text_provider || steps.providers.outputs.text || 'openai' }}
          IMAGE_PROVIDER: ${{ github.event.inputs.image_provider || steps.providers.outputs.image || 'openai' }}
          FACE_SWAP_PROVIDER: ${{ steps.providers.outputs.face_swap }}
          IMAGE_SOURCE: ${{ steps.providers.outputs.image_source || 'generate' }}
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          REPLICATE_API_KEY: ${{ secrets.REPLICATE_API_KEY }}
          GOOGLE_PROJECT_ID: ${{ secrets.GOOGLE_PROJECT_ID }}
          GOOGLE_LOCATION: ${{ secrets.GOOGLE_LOCATION }}
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
        run: python main.py generate

      - name: Commit pending draft
        if: steps.check.outputs.enabled != 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pending_post.json
          if [ -f image_library.json ]; then git add image_library.json; fi
          git diff --staged --quiet || git commit -m "Phase 1: draft generated for review [bot]"
          git push

# ── Phase 2: Auto-publish if not published manually ─────────────────────────

  publish:
    runs-on: ubuntu-latest
    if: >-
      (github.event_name == 'schedule' && github.event.schedule == '0 12 * * *')
      || (github.event_name == 'workflow_dispatch' && github.event.inputs.phase == 'publish')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Pull latest changes
        run: git pull origin main --rebase

      - name: Check if autopublish is enabled
        id: check
        run: |
          if [ -f provider.cfg ]; then
            ENABLED=$(grep AUTOPUBLISH_ENABLED provider.cfg | cut -d= -f2 || echo "true")
          else
            ENABLED="true"
          fi
          echo "enabled=$ENABLED" >> $GITHUB_OUTPUT
          echo "Autopublish enabled: $ENABLED"

      - name: Set up Python
        if: steps.check.outputs.enabled != 'false'
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        if: steps.check.outputs.enabled != 'false'
        run: pip install anthropic google-genai openai replicate requests python-dotenv Pillow pypdf python-docx

      - name: Read provider config
        if: steps.check.outputs.enabled != 'false'
        id: providers
        run: |
          if [ -f provider.cfg ]; then
            echo "publish_targets=$(grep PUBLISH_TARGETS provider.cfg | cut -d= -f2)" >> $GITHUB_OUTPUT
          else
            echo "publish_targets=telegram" >> $GITHUB_OUTPUT
          fi

      - name: Publish pending draft
        if: steps.check.outputs.enabled != 'false'
        env:
          PUBLISH_TARGETS: ${{ steps.providers.outputs.publish_targets || 'telegram' }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL_ID: ${{ secrets.TELEGRAM_CHANNEL_ID }}
          VK_ACCESS_TOKEN: ${{ secrets.VK_ACCESS_TOKEN }}
          VK_GROUP_ID: ${{ secrets.VK_GROUP_ID }}
          MAX_BOT_TOKEN: ${{ secrets.MAX_BOT_TOKEN }}
          MAX_CHAT_ID: ${{ secrets.MAX_CHAT_ID }}
          PINTEREST_ACCESS_TOKEN: ${{ secrets.PINTEREST_ACCESS_TOKEN }}
          PINTEREST_BOARD_ID: ${{ secrets.PINTEREST_BOARD_ID }}
        run: python main.py publish

      - name: Commit updated files
        if: steps.check.outputs.enabled != 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pending_post.json ideas.json history.json
          git diff --staged --quiet || git commit -m "Phase 2: auto-published [bot]"
          git push

# ── Full pipeline (legacy, for manual dispatch) ─────────────────────────────

  full:
    runs-on: ubuntu-latest
    if: >-
      github.event_name == 'workflow_dispatch' && github.event.inputs.phase == 'full'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install anthropic google-genai openai replicate requests python-dotenv Pillow pypdf python-docx

      - name: Read provider config
        id: providers
        run: |
          if [ -f provider.cfg ]; then
            echo "text=$(grep TEXT_PROVIDER provider.cfg | cut -d= -f2)" >> $GITHUB_OUTPUT
            echo "image=$(grep IMAGE_PROVIDER provider.cfg | cut -d= -f2)" >> $GITHUB_OUTPUT
            echo "face_swap=$(grep FACE_SWAP_PROVIDER provider.cfg | cut -d= -f2)" >> $GITHUB_OUTPUT
            echo "image_source=$(grep IMAGE_SOURCE provider.cfg | cut -d= -f2)" >> $GITHUB_OUTPUT
            echo "publish_targets=$(grep PUBLISH_TARGETS provider.cfg | cut -d= -f2)" >> $GITHUB_OUTPUT
          else
            echo "text=openai" >> $GITHUB_OUTPUT
            echo "image=openai" >> $GITHUB_OUTPUT
            echo "face_swap=" >> $GITHUB_OUTPUT
            echo "image_source=generate" >> $GITHUB_OUTPUT
            echo "publish_targets=telegram" >> $GITHUB_OUTPUT
          fi

      - name: Run full autoposter
        env:
          TEXT_PROVIDER: ${{ github.event.inputs.text_provider || steps.providers.outputs.text || 'openai' }}
          IMAGE_PROVIDER: ${{ github.event.inputs.image_provider || steps.providers.outputs.image || 'openai' }}
          FACE_SWAP_PROVIDER: ${{ steps.providers.outputs.face_swap }}
          IMAGE_SOURCE: ${{ steps.providers.outputs.image_source || 'generate' }}
          PUBLISH_TARGETS: ${{ steps.providers.outputs.publish_targets || 'telegram' }}
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          REPLICATE_API_KEY: ${{ secrets.REPLICATE_API_KEY }}
          GOOGLE_PROJECT_ID: ${{ secrets.GOOGLE_PROJECT_ID }}
          GOOGLE_LOCATION: ${{ secrets.GOOGLE_LOCATION }}
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL_ID: ${{ secrets.TELEGRAM_CHANNEL_ID }}
          VK_ACCESS_TOKEN: ${{ secrets.VK_ACCESS_TOKEN }}
          VK_GROUP_ID: ${{ secrets.VK_GROUP_ID }}
          MAX_BOT_TOKEN: ${{ secrets.MAX_BOT_TOKEN }}
          MAX_CHAT_ID: ${{ secrets.MAX_CHAT_ID }}
          PINTEREST_ACCESS_TOKEN: ${{ secrets.PINTEREST_ACCESS_TOKEN }}
          PINTEREST_BOARD_ID: ${{ secrets.PINTEREST_BOARD_ID }}
        run: python main.py full

      - name: Commit updated files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ideas.json history.json
          git diff --staged --quiet || git commit -m "Auto-publish: full pipeline [bot]"
          git push
